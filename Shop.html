<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop - NicFix Premium Vapes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #FF0000, #FF7F00, #FFFF00, #00FF00, #0000FF, #4B0082, #8B00FF); /* RGB Animated Background */
            background-size: 400% 400%;
            animation: gradientBG 25s ease infinite;
            color: #e0e7ff;
        }

        @keyframes gradientBG { /* Original RGB Animation */
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .rainbow-button {
            color: white; font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 8px -1px rgba(0,0,0,0.2), 0 2px 6px -2px rgba(0,0,0,0.15);
            border: none;
            display: inline-block;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .rainbow-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.25), 0 4px 8px -2px rgba(0,0,0,0.2);
        }
        .rainbow-button:active {
            transform: translateY(0px) scale(0.98);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3), 0 1px 2px 0 rgba(0,0,0,0.1);
        }

        /* Button color classes */
        .btn-red { background-color: #FF3B30; } .btn-red:hover { background-color: #E12D22; }
        .btn-orange { background-color: #FF9500; } .btn-orange:hover { background-color: #E18400; }
        .btn-yellow { background-color: #FFCC00; color: #1A202C; } .btn-yellow:hover { background-color: #E1B400; }
        .btn-green { background-color: #34C759; } .btn-green:hover { background-color: #2DAA4C; }
        .btn-blue { background-color: #007AFF; } .btn-blue:hover { background-color: #0069E1; }
        .btn-indigo { background-color: #5856D6; } .btn-indigo:hover { background-color: #4D4BC4; }
        .btn-violet { background-color: #AF52DE; } .btn-violet:hover { background-color: #9A43C3; }
        .btn-teal { background-color: #20C997; } .btn-teal:hover { background-color: #1BAA80; }
        .btn-pink { background-color: #ec4899; } .btn-pink:hover { background-color: #d83785; }
        .btn-lime { background-color: #84cc16; } .btn-lime:hover { background-color: #73b312;}
        .btn-cyan { background-color: #06b6d4; } .btn-cyan:hover { background-color: #05a1bd;}
        .btn-rose { background-color: #f43f5e; } .btn-rose:hover { background-color: #e03350;}
        .btn-amber { background-color: #fbbf24; color: #44403c; } .btn-amber:hover { background-color: #f59e0b;}
        .btn-sky { background-color: #38bdf8; } .btn-sky:hover { background-color: #0ea5e9;}


        .rainbow-text {
            background: linear-gradient(to right, #FF0000, #FF7F00, #FFFF00, #00FF00, #0000FF, #4B0082, #8B00FF);
            -webkit-background-clip: text; background-clip: text; color: transparent;
            animation: rainbowTextAnimation 10s linear infinite;
            background-size: 200% 200%;
        }

        @keyframes rainbowTextAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .nav-link {
            text-decoration: none; color: #c7d2fe;
            padding-bottom: 0.4rem;
            transition: color 0.25s ease-in-out, border-color 0.25s ease-in-out;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }
        .nav-link.active-main-nav {
            color: #FF9500;
            border-bottom-color: #FF9500;
            font-weight: 600;
        }
        .nav-link:not(.active-main-nav):hover {
            color: #ffffff;
            border-bottom-color: rgba(255, 149, 0, 0.5);
        }
        
        .content-card {
            background-color: rgba(17, 24, 39, 0.9);
            backdrop-filter: blur(12px);
            border-radius: 0.75rem;
            padding: 1.25rem;
            box-shadow: 0 12px 24px -8px rgba(0,0,0,0.6);
            border: 1px solid rgba(255, 255, 255, 0.07);
        }
        @media (min-width: 640px) {
            .content-card {
                padding: 1.75rem;
            }
        }

        .header-card {
            background-color: rgba(10, 10, 20, 0.92);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .product-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background-color: rgba(30, 41, 59, 0.88);
        }
        .product-card:hover {
            transform: translateY(-7px) scale(1.01);
            box-shadow: 0 18px 35px -12px rgba(0,0,0,0.7);
        }
        .product-image-container {
            background-color: rgba(255,255,255,0.04);
            aspect-ratio: 1 / 1;
            border-radius: 0.5rem;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        .product-card:hover .product-image-container {
            transform: scale(1.03);
        }
        .product-image-container img {
            transition: opacity 0.3s ease;
        }
        .product-card:hover .product-image-container img {
            opacity: 0.95;
        }

        .cart-modal-item {
            border-bottom: 1px solid #374151;
        }
        .cart-modal-item:last-child {
            border-bottom: none;
        }
        .filter-select {
            background-color: #1f2937;
            color: #e0e7ff;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            padding: 0.6rem 0.8rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .filter-select:focus, #searchBar:focus { /* Combined focus style */
            outline: none;
            border-color: #5856D6;
            box-shadow: 0 0 0 2px rgba(88, 86, 214, 0.3);
        }

        /* Cart Icon Animations */
        @keyframes spinCartIcon {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }
        .cart-icon-spin svg {
            animation: spinCartIcon 0.6s ease-in-out;
        }
        @keyframes pulseCartCount {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            50% { transform: scale(1.4); box-shadow: 0 0 0 8px rgba(99, 102, 241, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
        .cart-count-pulse {
            animation: pulseCartCount 0.6s ease-in-out;
        }


        /* Smoke Effect */
        .smoke-particle {
            position: fixed;
            background-color: rgba(235, 235, 245, 0.6);
            border-radius: 50%;
            pointer-events: none;
            animation: smokeAnimation 1.5s ease-out forwards;
            opacity: 0;
            z-index: 2000;
        }

        @keyframes smokeAnimation {
            0% {
                transform: scale(0.8) translate(0, 0);
                opacity: 1;
            }
            20% {
                opacity: 0.8;
            }
            100% {
                transform: scale(3.5) translate(var(--tx, 0px), var(--ty, -100px));
                opacity: 0;
            }
        }
        
        /* Modal Input Styling */
        .modal-input {
            background-color: #374151;
            color: #e0e7ff;
            border: 1px solid #4b5563;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .modal-input:focus {
            outline: none;
            border-color: #5856D6;
            box-shadow: 0 0 0 2px rgba(88, 86, 214, 0.3);
        }
        .modal-textarea {
            min-height: 80px;
        }
        .checkout-details-error {
            color: #f87171;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .payment-option label, .age-verification-option label {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: #374151;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: 1px solid #4b5563;
        }
        .payment-option input[type="radio"], .age-verification-option input[type="checkbox"] {
            margin-right: 0.5rem;
            accent-color: #5856D6; /* Indigo */
        }
        .payment-option label:hover, .age-verification-option label:hover {
            background-color: #4b5563;
        }
        .payment-option input[type="radio"]:checked + span, .age-verification-option input[type="checkbox"]:checked + span {
            font-weight: 600;
            color: #a5b4fc; /* Lighter indigo for selected text */
        }

    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="header-card shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 py-3 sm:py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3 sm:space-x-4">
                <a href="index.html">
                    <img src="NixFix.jpg" alt="NicFix Logo" class="h-10 sm:h-12 w-auto rounded-md" onerror="this.outerHTML = `<div class='h-10 sm:h-12 w-24 flex-shrink-0 items-center justify-center border-2 border-dashed border-gray-600 rounded-md bg-gray-700/50 text-gray-400 text-xs p-2 text-center leading-tight shadow-inner'>Logo Not Found:<br>NicFix.jpg</div>`; console.error('Logo not found: NicFix.jpg. Please ensure the image file is in the correct path.');">
                </a>
                <a href="index.html" class="text-2xl sm:text-3xl font-extrabold rainbow-text">NicFix</a>
            </div>
            <nav>
                <ul class="flex space-x-3 sm:space-x-6 items-center">
                    <li><a href="index.html" class="nav-link text-sm sm:text-base">Home</a></li>
                    <li><a href="Shop.html" class="nav-link text-sm sm:text-base active-main-nav">Shop</a></li>
                    <li><a href="Social.html" class="nav-link text-sm sm:text-base">Social</a></li>
                    <li>
                        <a href="#" id="cartLink" class="relative text-gray-400 hover:text-white transition-colors p-2 rounded-full hover:bg-gray-700/50" title="Shopping Cart">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            <span id="cartItemCount" class="absolute -top-1 -right-1 text-xs bg-indigo-500 text-white rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-semibold">0</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 py-10 md:py-12 lg:py-16 flex-grow">
        <div class="text-center mb-10 md:mb-14">
            <h1 class="text-4xl sm:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 via-blue-400 to-purple-500">Discover Our Collection</h1>
            <p class="text-lg sm:text-xl text-indigo-200 mt-3 max-w-2xl mx-auto">Premium vapes, exceptional flavors. Your next fix awaits.</p>
        </div>

        <div class="mb-8 p-4 content-card rounded-lg">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-100">Browse Products</h2>
                <div class="flex flex-col sm:flex-row items-center gap-3 sm:gap-4 w-full sm:w-auto">
                    <div class="w-full sm:w-auto">
                        <input type="text" id="searchBar" placeholder="Search products..." class="filter-select text-sm w-full sm:max-w-xs md:w-64">
                        <p id="searchTermDisplay" class="text-xs text-gray-400 mt-1 ml-1 hidden"></p>
                    </div>
                    <div class="flex items-center space-x-3 w-full sm:w-auto">
                        <label for="sortProducts" class="text-sm text-gray-300 whitespace-nowrap">Sort by:</label>
                        <select id="sortProducts" name="sortProducts" class="filter-select text-sm w-full">
                            <option value="featured">Featured</option>
                            <option value="price_asc">Price: Low to High</option>
                            <option value="price_desc">Price: High to Low</option>
                            <option value="newest">Newest Arrivals</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 md:gap-8" id="productGrid">
            </div>
    </main>

    <footer class="bg-black/90 py-10 text-center border-t border-gray-700/50 mt-auto">
        <p class="text-gray-200 text-lg">&copy; <span id="currentYear"></span> <span class="font-bold rainbow-text">NicFix</span>. All rights reserved.</p>
        <p class="text-sm text-gray-400 mt-3 px-4">Based in Springs, Gauteng, South Africa. Responsible vaping is advised. Products are for adult use only (18+).</p>
    </footer>

    <div id="cartModal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-[1000] hidden p-4 transition-opacity duration-300 ease-in-out opacity-0">
        <div class="bg-slate-800 p-5 sm:p-6 rounded-xl shadow-2xl w-full max-w-md md:max-w-lg max-h-[90vh] flex flex-col border border-slate-700 transform transition-all duration-300 ease-in-out scale-95 opacity-0" id="cartModalContent">
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-slate-600">
                <h2 class="text-xl sm:text-2xl font-semibold text-white">Your Shopping Cart</h2>
                <button id="closeCartModalBtn" class="text-gray-400 hover:text-red-400 transition-colors p-1 rounded-md text-2xl leading-none">&times;</button>
            </div>
            <div id="cartModalBody" class="flex-grow overflow-y-auto mb-4 pr-1 space-y-3">
                <p id="emptyCartMessage" class="text-gray-400 text-center py-8 text-sm">Your cart is currently empty. Start shopping!</p>
            </div>
            <div class="border-t border-slate-600 pt-4 space-y-2">
                <div class="flex justify-between items-center">
                    <p class="text-sm text-gray-300">Subtotal:</p>
                    <p id="cartSubtotal" class="text-sm text-white font-medium">R0.00</p>
                </div>
                <div id="deliveryFeeSectionCart" class="flex justify-between items-center" style="display: none;">
                    <p class="text-sm text-gray-300">Delivery Fee:</p>
                    <p id="cartDeliveryFee" class="text-sm text-white font-medium">R0.00</p>
                </div>
                <div class="flex justify-between items-center pt-1 mt-1 border-t border-slate-700">
                    <p class="text-md sm:text-lg text-gray-100 font-semibold">Total:</p>
                    <p id="cartGrandTotal" class="text-md sm:text-lg text-white font-bold">R0.00</p>
                </div>
                <button id="proceedToCheckoutDetailsBtn" class="w-full rainbow-button btn-green text-sm sm:text-base py-2.5 mt-3">Proceed to Checkout</button>
            </div>
        </div>
    </div>

    <div id="checkoutDetailsModal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-[1001] hidden p-4 transition-opacity duration-300 ease-in-out opacity-0">
        <div class="bg-slate-800 p-5 sm:p-6 rounded-xl shadow-2xl w-full max-w-md md:max-w-lg max-h-[95vh] flex flex-col border border-slate-700 transform transition-all duration-300 ease-in-out scale-95 opacity-0" id="checkoutDetailsModalContent">
            <div class="flex justify-between items-center mb-6 pb-3 border-b border-slate-600">
                <h2 class="text-xl sm:text-2xl font-semibold text-white">Delivery & Payment</h2>
                <button id="closeCheckoutDetailsModalBtn" class="text-gray-400 hover:text-red-400 transition-colors p-1 rounded-md text-2xl leading-none">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto mb-4 pr-1 space-y-4">
                <div>
                    <label for="firstName" class="block text-sm font-medium text-indigo-200 mb-1">First Name</label>
                    <input type="text" id="firstName" name="firstName" class="modal-input" placeholder="e.g., John">
                    <p id="firstNameError" class="checkout-details-error hidden">First name is required.</p>
                </div>
                <div>
                    <label for="surname" class="block text-sm font-medium text-indigo-200 mb-1">Surname</label>
                    <input type="text" id="surname" name="surname" class="modal-input" placeholder="e.g., Doe">
                    <p id="surnameError" class="checkout-details-error hidden">Surname is required.</p>
                </div>
                <div>
                    <label for="address" class="block text-sm font-medium text-indigo-200 mb-1">Delivery Address</label>
                    <textarea id="address" name="address" rows="3" class="modal-input modal-textarea" placeholder="e.g., 123 Vape Street, Springs, Gauteng"></textarea>
                    <p id="addressError" class="checkout-details-error hidden">Delivery address is required.</p>
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-indigo-200 mb-1">Phone Number</label>
                    <input type="tel" id="phone" name="phone" class="modal-input" placeholder="e.g., 0821234567">
                    <p id="phoneError" class="checkout-details-error hidden">Phone number is required.</p>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-indigo-200 mb-2">Payment Method</label>
                    <div class="space-y-2">
                        <div class="payment-option">
                             <label for="paymentCod">
                                <input type="radio" id="paymentCod" name="paymentMethod" value="Cash on Delivery" class="modal-input-radio">
                                <span>Cash on Delivery</span>
                             </label>
                        </div>
                        <div class="payment-option">
                            <label for="paymentEft">
                                <input type="radio" id="paymentEft" name="paymentMethod" value="EFT" class="modal-input-radio">
                                <span>EFT (Electronic Funds Transfer)</span>
                            </label>
                        </div>
                    </div>
                    <p id="paymentMethodError" class="checkout-details-error hidden">Please select a payment method.</p>
                </div>
                <div class="mt-4 age-verification-option">
                      <label for="ageConfirmation">
                        <input type="checkbox" id="ageConfirmation" name="ageConfirmation" class="modal-input-checkbox">
                        <span>I confirm I am 18 years or older and agree to the terms of sale.</span>
                      </label>
                      <p id="ageConfirmationError" class="checkout-details-error hidden">You must confirm you are 18+ to proceed.</p>
                </div>
            </div>
            <div class="border-t border-slate-600 pt-4 space-y-3">
                 <p id="checkoutFormError" class="checkout-details-error text-center hidden">Please fill in all required fields, select a payment method, and confirm your age.</p>
                <div class="flex space-x-3">
                    <button id="backToCartBtn" class="w-1/2 rainbow-button btn-orange text-sm sm:text-base py-2.5">Back to Cart</button>
                    <button id="confirmOrderBtn" class="w-1/2 rainbow-button btn-green text-sm sm:text-base py-2.5">Confirm & Email</button>
                </div>
            </div>
        </div>
    </div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        let cart = JSON.parse(sessionStorage.getItem('nicfixCart')) || [];
        
        const rawProductData = [
            { id: 1, name: "VAPORESSO XROS 4 MINI", description: "Refillable Pod System", details: "3ml Pod Capacity", price: 440.00, image: "https://wizvape.co.uk/cdn/shop/files/XROS4MINI-black_700x700.webp?v=1714408741", colorClass: "btn-indigo", textColorClass: "text-purple-300" },
            { id: 2, name: "Solobar S10000 - Apple Smoothies", description: "Flavor: Apple Smoothies", details: "10000 Puffs", price: 180.00, image: "https://bhikaimports.co.za/wp-content/uploads/2024/04/Apple-Smoothies.png", colorClass: "btn-green", textColorClass: "text-green-300" },
            { id: 3, name: "Solobar S10000 - Lady Killer", description: "Flavor: Lady Killer", details: "10000 Puffs", price: 180.00, image: "https://bhikaimports.co.za/wp-content/uploads/2024/04/Lady-Killer.png", colorClass: "btn-yellow", textColorClass: "text-yellow-300" },
            { id: 4, name: "Solobar S10000 - Watermelon Strawberry", description: "Flavor: Watermelon Strawberry Freeze", details: "10000 Puffs", price: 180.00, image: "https://bhikaimports.co.za/wp-content/uploads/2024/04/Strawberry-Watermelon-Freeze.png", colorClass: "btn-red", textColorClass: "text-red-300" },
            { id: 5, name: "Solobar S10000 - Blue Cherry Dragon Fruit", description: "Flavor: Blue Cherry Dragon Fruit", details: "10000 Puffs", price: 180.00, image: "https://bhikaimports.co.za/wp-content/uploads/2024/04/Blue-Cherry-Dragon-Fruit.png", colorClass: "btn-blue", textColorClass: "text-blue-300" },
            { id: 6, name: "Solobar S10000 - Cherry Sparkling Juice", description: "Flavor: Cherry Sparkling Juice", details: "10000 Puffs", price: 180.00, image: "https://bhikaimports.co.za/wp-content/uploads/2024/04/Cherry-Sparkling-Juice.png", colorClass: "btn-pink", textColorClass: "text-pink-300" },
            { id: 7, name: "SMOK AIRPEN", description: "Compact Pod Device", details: "Pen-style Vape", price: 210.00, image: "https://www.lca-distribution.com/44558-thickbox_default/kit-airpen-1100mah-smoktech.jpg", colorClass: "btn-orange", textColorClass: "text-orange-300" },
            { id: 8, name: "VOZOL VISTA 20000", description: "Rechargeable Vape Bar", details: "20000 Puffs", price: 285.00, image: "https://th.bing.com/th/id/OIP.MosHnR5U6rz2jVnvmFlmxAHaHa?cb=iwp2&rs=1&pid=ImgDetMain", colorClass: "btn-violet", textColorClass: "text-violet-300" },
            { id: 9, name: "VAPORESSO XROS PRO POD KIT", description: "Advanced Pod Kit", details: "Professional Grade", price: 530.00, image: "https://th.bing.com/th/id/OIP.xW1o5giYZ10O8F3uMZxcbwHaHa?cb=iwp2&rs=1&pid=ImgDetMain", colorClass: "btn-teal", textColorClass: "text-teal-300" },
            { id: 10, name: "NASTY RECHARGEABLE BAR 16000", description: "Rechargeable Bar 50MG", details: "16000 Puffs", price: 240.00, image: "https://wickedimports.co.za/wp-content/uploads/2024/02/Cola-Ice.png", colorClass: "btn-rose", textColorClass: "text-rose-300" },
            { id: 11, name: "IQOS ILUMA ONE KIT", description: "Heated Tobacco Device", details: "All-in-one Design", price: 460.00, image: "https://cdn.public.steam-time.de/images/org/Iqos-Iluma-One-_0000_Galerie.jpg", colorClass: "btn-indigo", textColorClass: "text-indigo-300" },
            { id: 12, name: "WICKED JUICE LONGFILL", description: "E-Liquid Concentrate", details: "Add Your Own Nicotine", price: 92.00, image: "https://www.vapoter.fr/images/products/p_46003-31088-wicked-haze-longfill-nasty-juice-20ml-00mg.jpg", colorClass: "btn-lime", textColorClass: "text-lime-300" },
            { id: 13, name: "VAPENGIN CERES RECHARGEABLE BAR", description: "Rechargeable Disposable", details: "High Puff Count", price: 305.00, image: "https://wickedimports.co.za/wp-content/uploads/2024/12/Vapengin-Ceres-400x400.png", colorClass: "btn-yellow", textColorClass: "text-yellow-400" },
            { id: 14, name: "ELFBAR RECHARGEABLE POD KIT", description: "Rechargeable Pod System", details: "Popular & Reliable", price: 250.00, image: "https://wildfirevape.co.uk/wp-content/uploads/2022/10/elfa-pod-kit-reusable-elf-bar.jpg", colorClass: "btn-pink", textColorClass: "text-pink-400" },
            { id: 15, name: "SMOK NOVO PRO POD KIT", description: "Advanced Pod System", details: "Feature-Rich", price: 400.00, image: "https://th.bing.com/th/id/R.d6924467680906af3aae2be80e351ca4?rik=zgptB6iw0CS6Tg&riu=http%3a%2f%2fwww.ecigwizard.com%2fcdn%2fshop%2ffiles%2fsmok-novo-pro-kit-black-carbon-fibre_1024x1024.png%3fv%3d1704284610&ehk=1f0WLkbgl9GGVw9liE1A37gwwyXv%2b8y%2biW6Cf5uY6Z4%3d&risl=&pid=ImgRaw&r=0", colorClass: "btn-cyan", textColorClass: "text-cyan-300" },
            { id: 16, name: "VAPENGIN RECHARGEBALE BAR 8500", description: "Rechargeable Bar 50MG", details: "8500 Puffs", price: 130.00, image: "https://wickedimports.co.za/wp-content/uploads/2024/03/Strawberry-Banana-Smoothie-800x800.png", colorClass: "btn-green", textColorClass: "text-green-400" },
            { id: 17, name: "HELLVAPE DISPOSABLE POD 5000", description: "Disposable Pod 20MG", details: "5000 Puffs", price: 110.00, image: "https://www.losvapos.co.za/wp-content/uploads/2023/11/Los-Vapos-Hellvape-P1-5000-Puffs-Disposable-Flavour-Pod-20mg.jpg", colorClass: "btn-red", textColorClass: "text-red-400" },
            { id: 18, name: "VAPORESSO XROS 3 MINI POD KIT", description: "Compact Pod Kit", details: "Reliable & Sleek", price: 380.00, image: "https://www.3mvcdmx.com/wp-content/uploads/2023/04/vaporesso-xros-3-mini-pod-kit-navy-blue.jpg", colorClass: "btn-indigo", textColorClass: "text-indigo-400" },
            { id: 19, name: "SMOK NOVO POD KIT", description: "Classic Pod System", details: "Compact & Easy to Use", price: 190.00, image: "https://cdn10.bigcommerce.com/s-fi8xpl/products/884/images/3872/smok-novo-pod-vape-kit__28118.1553167831.1280.1280.JPG?c=2", colorClass: "btn-pink", textColorClass: "text-pink-400" },
            { id: 20, name: "ONE CLOUD TUGBOAT POD KIT", description: "Pod System", details: "Durable Build", price: 280.00, image: "https://media.takealot.com/covers_images/50db468b259140cbbd89f151f6054b1a/s-zoom.file", colorClass: "btn-sky", textColorClass: "text-sky-400" },
            { id: 21, name: "VAPORESSO XROS 4 MINI POD KIT ART EDITION", description: "Vaporesso Pod Kit", details: "Special Edition Design", price: 425.00, image: "https://thevapestudio.co.za/cdn/shop/files/VaporessoXROS4MiniArtEditionPodKitCamoStar1.jpg?v=1731583040&width=990", colorClass: "btn-violet", textColorClass: "text-purple-400" },
            { id: 22, name: "VOOM RECHARGEABLE BAR 1200 PLUS", description: "Rechargeable Disposable", details: "~1200 Puffs", price: 215.00, image: "https://arenatobacco.com/wp-content/uploads/Peach-ice.png", colorClass: "btn-cyan", textColorClass: "text-cyan-400" },
            { id: 23, name: "ELF RECHARGEABLE VAPE BAR- ICE KING", description: "Rechargeable Vape Bar", details: "Cooling Flavors", price: 310.00, image: "https://www.expresstabacaria.com.br/timthumb.php?src=image/catalog/pod/poddescartavel/elfbar/40kice/40kiceking.png&w=800=&h=800&zc=1", colorClass: "btn-blue", textColorClass: "text-blue-400" },
            { id: 24, name: "ZLAND MINI RECHARGEABLE BATTERY", description: "Rechargeable Battery", details: "For ZLAND Mini Pods", price: 103.00, image: "https://th.bing.com/th/id/OIP.HwRUHfXq1Sk54Z5tEmKhxQHaHa?cb=iwp2&rs=1&pid=ImgDetMain", colorClass: "btn-amber", textColorClass: "text-amber-400" },
            { id: 25, name: "NOVO POD REPLACEMENT", description: "Pod Accessory", details: "Replacement Pod", price: 65.00, image: "https://th.bing.com/th/id/OIP.IWYOLNVaLWG6e2TBOaXTDQHaHa?w=1200&h=1200&rs=1&pid=ImgDetMain", colorClass: "btn-red", textColorClass: "text-red-300" },
            { id: 26, name: "PODS PLUS LONGFILL", description: "E-Liquid Concentrate", details: "Longfill E-Liquid", price: 92.00, image: "https://th.bing.com/th/id/OIP.UbSFoZA2qvhQqm8ZcmaDHAHaHa?rs=1&pid=ImgDetMain", colorClass: "btn-orange", textColorClass: "text-orange-300" },
            { id: 27, name: "PODS & SALTS LONGFILL", description: "E-Liquid Concentrate", details: "Longfill E-Liquid", price: 85.00, image: "https://s3.amazonaws.com/images.ecwid.com/images/72493436/4029866138.jpg", colorClass: "btn-yellow", textColorClass: "text-yellow-300" },
            { id: 28, name: "RAW NICOTINE SHOT 50MG", description: "Nicotine Additive", details: "50MG Nicotine Shot", price: 110.00, image: "https://th.bing.com/th/id/OIP.1GRMUMaipFKehTjKKkst3gHaHa?rs=1&pid=ImgDetMain", colorClass: "btn-green", textColorClass: "text-green-300" },
            { id: 29, name: "ONE CLOUD TUGBOAT REPLACEMENT PODS", description: "Pod Accessory", details: "For Tugboat Kit", price: 70.00, image: "https://image.made-in-china.com/2f0j00pcYoRzgCYWbO/Tugboat-Replaced-Cartridge-Super-Pod-7000-12000-Puffs-Manufacturer-Direct-Sales-Life-Pod-Vaporizer-Pod.jpg", colorClass: "btn-blue", textColorClass: "text-blue-300" },
            { id: 30, name: "NASTY RECHARGEABLE BAR MAX 30000 50MG", description: "Rechargeable Vape Bar", details: "30000 Puffs, 50MG", price: 310.00, image: "https://wickedimports.co.za/wp-content/uploads/2025/02/Nasty-30000-1-200x200.png", colorClass: "btn-indigo", textColorClass: "text-indigo-300" },
            { id: 31, name: "ZLAND MINI DISPOSABLE POD", description: "Disposable Pod", details: "For ZLAND System", price: 70.00, image: "https://jm-wholesale.co.uk/cdn/shop/files/Gray_kit_2048x2048.jpg?v=1738666919", colorClass: "btn-violet", textColorClass: "text-purple-300" },
            { id: 32, name: "NASTY RECHARGEABLE BAR 14000", description: "Rechargeable Vape Bar", details: "14000 Puffs", price: 230.00, image: "https://www.usbandmore.co.za/cdn/shop/files/Screenshot2025-01-14at14-22-56NastyRechargeableBar-X-NIC14000-WickedImports_Pty_Ltd_1024x1024@2x.png?v=1736862721", colorClass: "btn-teal", textColorClass: "text-teal-300" },
            { id: 33, name: "NASTY RECHARGEABLE BAR X-NIC", description: "Rechargeable Vape Bar", details: "X-NIC Series", price: 230.00, image: "https://coffeeandvape.co.za/cdn/shop/files/Strawberry-Ice-2_Nasty_Bar_X_9000_Disposable_Vape.webp?v=1725539052&width=1445", colorClass: "btn-pink", textColorClass: "text-pink-300" },
            { id: 35, name: "ELF DISPOSABLE POD 9000", description: "Disposable Vape", details: "9000 Puffs", price: 140.00, image: "https://www.libertyvape.ca/cdn/shop/files/elf-bar-ew9000-disposable-pod-starter-kit-9000-puffs-16ml-41811400458479_1024x1024.webp?v=1718929333", colorClass: "btn-cyan", textColorClass: "text-cyan-300" },
            { id: 36, name: "VAPENGIN RECHARGEABLE BAR MARS 20000", description: "Rechargeable Vape Bar", details: "20000 Puffs", price: 295.00, image: "https://media.portmoni.com/84499/vapengin_mars.jpg", colorClass: "btn-rose", textColorClass: "text-rose-300" },
            { id: 37, name: "SOLOBAR RECHARGEABLE REVOLVER POD", description: "Pod Accessory", details: "For Revolver Kit", price: 75.00, image: "https://wickedimports.co.za/wp-content/uploads/2024/06/POD-Solo-Bull-400x400.png", colorClass: "btn-amber", textColorClass: "text-amber-400" },
            { id: 38, name: "SOLOBAR RECHARGEABLE REVOLVER KIT", description: "Pod System Kit", details: "Rechargeable Kit", price: 250.00, image: "https://wickedimports.co.za/wp-content/uploads/2024/06/KIT.png", colorClass: "btn-sky", textColorClass: "text-sky-300" },
            { id: 39, name: "NASTY DISPOSABLE POD", description: "Disposable Vape", details: "Convenient Pod", price: 115.00, image: "https://vape.co.uk/product/10mg-nasty-fix-disposable-vape-pod-675-puffs/JWN10mgNastyFixVape5.jpg", colorClass: "btn-red", textColorClass: "text-red-300" },
            { id: 40, name: "ELFBAR RECHARGEABLE VAPE BAR 18000", description: "Rechargeable Vape Bar", details: "18000 Puffs", price: 280.00, image: "https://media.portmoni.com/84499/ELF_BAR_GLkn6v8.jpg", colorClass: "btn-orange", textColorClass: "text-orange-300" },
            { id: 41, name: "NASTY RECHARGEABLE BAR 20000 PUFF 5MG", description: "Rechargeable Vape Bar", details: "20000 Puffs, 5MG", price: 275.00, image: "https://vapewholesaleusa.com/media/amasty/webp/catalog/product/cache/d96b96d9c12f2c2b4ad9e39d4f520b12/n/a/nasty-disposable-20000-puff-1_jpg.webp", colorClass: "btn-yellow", textColorClass: "text-yellow-300" },
            { id: 42, name: "NASTY DLT RECHARGEABLE BAR 10000 PUFF 3MG", description: "Rechargeable Vape Bar", details: "10000 Puffs, 3MG DLT", price: 260.00, image: "https://www.downtownvapoury.co.za/cdn/shop/files/nasty-dtl-rechargeable-bar-10000-puff-3mgdowntown-vapoury-913746.png?v=1715060467", colorClass: "btn-green", textColorClass: "text-green-300" },
            { id: 43, name: "VAPORESSO XROS SERIES REPLACEMENT POD", description: "Pod Accessory", details: "For XROS Series", price: 65.00, image: "https://cdn11.bigcommerce.com/s-n0pphwyuq9/images/stencil/1280x1280/products/1007/5103/001__48831.1683262516.jpg?c=1&imbypass=on", colorClass: "btn-blue", textColorClass: "text-blue-300" },
            { id: 44, name: "IQOS ILUMA KIT", description: "Heated Tobacco Device", details: "Full Kit", price: 750.00, image: "https://th.bing.com/th/id/OIP.Pw_vUIt559Sr7nzpyV_vswHaHa?rs=1&pid=ImgDetMain", colorClass: "btn-indigo", textColorClass: "text-indigo-300" },
            { id: 45, name: "SOLOBAR RECHARGEABLE BAR 10000 PUFF 50 MG", description: "Rechargeable Vape Bar", details: "10000 Puffs, 50MG", price: 180.00, image: "https://vapebyffenics.co.za/wp-content/uploads/2024/11/Solobar-Rechargeable-Revolver-Kit-10-000-Disposable-50mg-includes-4-pre-filled-pods.jpeg", colorClass: "btn-violet", textColorClass: "text-purple-300" },
            { id: 46, name: "NASTY RECHARGEABLE BATTERY", description: "Accessory", details: "Rechargeable Battery", price: 165.00, image: "https://wickedimports.co.za/wp-content/uploads/2024/02/NSTB01-Black.png", colorClass: "btn-teal", textColorClass: "text-teal-300" },
            { id: 47, name: "HELLVAPE RECHARGEABLE POD VAPE", description: "Rechargeable Pod System", details: "Compact Vape", price: 165.00, image: "https://wickedimports.co.za/wp-content/uploads/2024/01/Battery.png", colorClass: "btn-pink", textColorClass: "text-pink-300" },
            { id: 48, name: "VOZOL SWITCH POD 1600C POD 50 MG", description: "Pod Accessory", details: "1600 Puffs, 50MG", price: 130.00, image: "https://th.bing.com/th/id/OIP.tATj62_yrVZ2A-etZJoM8QHaHa?w=900&h=900&rs=1&pid=ImgDetMain", colorClass: "btn-lime", textColorClass: "text-lime-300" },
            { id: 49, name: "VOZOL SWITCH 1600C RECHARGEABLE POD KIT 50 MG", description: "Pod System Kit", details: "1600 Puffs, 50MG Kit", price: 200.00, image: "https://wickedimports.co.za/wp-content/uploads/2023/11/Switch-1600.png", colorClass: "btn-cyan", textColorClass: "text-cyan-300" },
            { id: 50, name: "LOCAL VAPING LIQUID DRIP 'N GO 30 MG 30ML", description: "E-Liquid", details: "30MG, 30ML", price: 180.00, image: "https://th.bing.com/th/id/OIP.q5EKTguOKXb2OUE2WfGGbwHaHa?rs=1&pid=ImgDetMain", colorClass: "btn-rose", textColorClass: "text-rose-300" },
            { id: 51, name: "MINIPOD DISPOSABLE VAPE 1000 PUFF 50 MG", description: "Disposable Vape", details: "1000 Puffs, 50MG", price: 100.00, image: "https://wickedimports.co.za/wp-content/uploads/2023/09/Peach-Mango.png", colorClass: "btn-amber", textColorClass: "text-amber-400" },
            { id: 52, name: "CBD DISPOSABLE VAPE PEN JACKPOT 600MG", description: "CBD Vape Pen", details: "600MG CBD", price: 430.00, image: "https://th.bing.com/th/id/OIP.J8NIPTlZad8SUiory4fLgQHaHa?rs=1&pid=ImgDetMain", colorClass: "btn-sky", textColorClass: "text-sky-300" },
            { id: 53, name: "NASTY 9000 PUFF RECHARGEABLE 50MG", description: "Rechargeable Vape Bar", details: "9000 Puffs, 50MG", price: 210.00, image: "https://th.bing.com/th/id/R.78c9d9d10212cf3299a4887157fca1a6?rik=Qy3Cz%2fWngrDWng&riu=http%3a%2f%2fsavestore.co.za%2fcdn%2fshop%2ffiles%2fNasty9000.jpg%3fv%3d1728816391&ehk=zhi1aJAVL3Tvn6qNcyNTG8yBOcCZ9YRjsgMfj%2fjLmYw%3d&risl=&pid=ImgRaw&r=0", colorClass: "btn-red", textColorClass: "text-red-300" },
            { id: 54, name: "AMAREN DISPOSABLE VAPE 3500", description: "Disposable Vape", details: "3500 Puffs", price: 50.00, image: "https://got-a-lot.com/wp-content/uploads/2023/03/Joburg-Nights-AMA08.png", colorClass: "btn-orange", textColorClass: "text-orange-300" },
            { id: 55, name: "LOCAL VAPING LIQUID PODS & SALTS- SALT NIC 50MG-30ML", description: "E-Liquid", details: "Salt Nic, 50MG, 30ML", price: 210.00, image: "https://www.cloudvape.co.za/wp-content/uploads/2023/09/Pods-n-Salts-50mg-30ml.jpg", colorClass: "btn-yellow", textColorClass: "text-yellow-300" },
            { id: 56, name: "ELF DISPOSABLE VAPE BAR 2500 PUFF", description: "Disposable Vape Bar", details: "2500 Puffs", price: 160.00, image: "https://cdn.shopify.com/s/files/1/0595/1425/7564/products/elf-bar-2500-disposable-vape-pod-box-of-10-vape-puff-disposable-923624_1000x.jpg?v=1668364667", colorClass: "btn-green", textColorClass: "text-green-300" },
            { id: 57, name: "WICKED JOOCE PREMIUM", description: "Premium E-Liquid", details: "High Quality Juice", price: 140.00, image: "https://wickedimports.co.za/wp-content/uploads/2022/04/Asssorted-Premium.png", colorClass: "btn-blue", textColorClass: "text-blue-300" },
            { id: 58, name: "SMOK NOVO 2 POD SYSTEM", description: "Pod System Kit", details: "Upgraded Novo Version", price: 350.00, image: "https://wickedimports.co.za/wp-content/uploads/2021/07/Vaping-Device-SMOK-Novo-2-Pod-System.png", colorClass: "btn-indigo", textColorClass: "text-indigo-300" },
            { id: 59, name: "NASTY X RECHARGEABLE 14000", description: "Rechargeable Vape Bar", details: "14000 Puffs", price: 230.00, image: "https://media.takealot.com/covers_images/769d01d3bd0b484888f368565695b837/s-zoom.file", colorClass: "btn-violet", textColorClass: "text-purple-300" },
            { id: 60, name: "HUBBLY COAL- BLUE MIX COCONUT SHELL COAL XL YELLOW 72 PIECE", description: "Hookah Accessory", details: "Coconut Shell Coal, 72 Pieces", price: 110.00, image: "https://wickedimports.co.za/wp-content/uploads/2023/01/HUB-COA027.png", colorClass: "btn-teal", textColorClass: "text-teal-300" },
            { id: 61, name: "HOOKAH LITE COAL", description: "Hookah Accessory", details: "Lite Coal", price: 30.00, image: "https://wickedimports.co.za/wp-content/uploads/2021/07/Hubbly-Bubbly-Coal-Hookah-Lite-Charcoal.png", colorClass: "btn-pink", textColorClass: "text-pink-300" },
            { id: 62, name: "SUPA GOLD LARGE", description: "Hookah Accessory", details: "Large Coal", price: 35.00, image: "https://wickedimports.co.za/wp-content/uploads/2021/07/Hubbly-Bubbly-Coal-Supa-Gold-Large.png", colorClass: "btn-lime", textColorClass: "text-lime-300" },
            { id: 63, name: "BLUE MIX COAL 38 CM", description: "Hookah Accessory", details: "38 CM Coal", price: 30.00, image: "https://th.bing.com/th/id/R.1888adc6830fb36fa1bee68c5bc3ea18?rik=rJ1nCWTLN0kVHg&riu=http%3a%2f%2fafricasexclusivetobacconist.co.za%2fcdn%2fshop%2fproducts%2fHUB003.png%3fv%3d1649447814&ehk=C4JoYaQrxvHIe6ZAepLsgYUaWD0BsvJHTMoW88l4hUI%3d&risl=&pid=ImgRaw&r=0", colorClass: "btn-cyan", textColorClass: "text-cyan-300" },
            { id: 64, name: "PHOENIX COAL 38 MM", description: "Hookah Accessory", details: "38 MM Coal", price: 22.00, image: "https://wickedimports.co.za/wp-content/uploads/2021/07/Hubbly-Bubbly-Coal-Blue-Mix-Coconut-Shell-Coal-1kg.png", colorClass: "btn-rose", textColorClass: "text-rose-300" },
            { id: 65, name: "BLUE MIX COCONUT SHELL COAL 24 PIECE", description: "Hookah Accessory", details: "Coconut Shell Coal, 24 Pieces", price: 45.00, image: "https://royalsmokers.co.za/wp-content/uploads/2021/07/BLUE-MIX-COCONUT-SMALL-768x768.jpg", colorClass: "btn-amber", textColorClass: "text-amber-400" },
            { id: 66, name: "BLUE MIX COCONUT SHELL COAL 96 PIECE", description: "Hookah Accessory", details: "Coconut Shell Coal, 96 Pieces", price: 110.00, image: "https://royalsmokers.co.za/wp-content/uploads/2021/07/BLUE-MIX-COCONUT-LARGE-768x768.jpg", colorClass: "btn-sky", textColorClass: "text-sky-300" }
        ];
        const initialProducts = rawProductData.map((p, idx) => ({ ...p, originalFeaturedOrder: idx }));
        
        const productGridContainer = document.getElementById('productGrid');
        const cartLink = document.getElementById('cartLink');
        const cartModal = document.getElementById('cartModal');
        const cartModalContent = document.getElementById('cartModalContent');
        const closeCartModalBtn = document.getElementById('closeCartModalBtn');
        const cartModalBody = document.getElementById('cartModalBody');
        
        const cartSubtotalElement = document.getElementById('cartSubtotal');
        const deliveryFeeSectionCart = document.getElementById('deliveryFeeSectionCart');
        const cartDeliveryFeeElement = document.getElementById('cartDeliveryFee');
        const cartGrandTotalElement = document.getElementById('cartGrandTotal');

        const cartItemCountElement = document.getElementById('cartItemCount');
        const proceedToCheckoutDetailsBtn = document.getElementById('proceedToCheckoutDetailsBtn');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        
        const sortSelect = document.getElementById('sortProducts');
        const searchBar = document.getElementById('searchBar');
        const searchTermDisplay = document.getElementById('searchTermDisplay');

        // Checkout Details Modal Elements
        const checkoutDetailsModal = document.getElementById('checkoutDetailsModal');
        const checkoutDetailsModalContent = document.getElementById('checkoutDetailsModalContent');
        const closeCheckoutDetailsModalBtn = document.getElementById('closeCheckoutDetailsModalBtn');
        const backToCartBtn = document.getElementById('backToCartBtn');
        const confirmOrderBtn = document.getElementById('confirmOrderBtn');
        const firstNameInput = document.getElementById('firstName');
        const surnameInput = document.getElementById('surname');
        const addressInput = document.getElementById('address');
        const phoneInput = document.getElementById('phone');
        const ageConfirmationCheckbox = document.getElementById('ageConfirmation');
        const checkoutFormError = document.getElementById('checkoutFormError');
        const paymentMethodError = document.getElementById('paymentMethodError');
        const ageConfirmationError = document.getElementById('ageConfirmationError');


        function renderProducts(productsToRender) {
            productGridContainer.innerHTML = '';

            if (!Array.isArray(productsToRender) || productsToRender.length === 0) {
                let message = "No products found matching your criteria.";
                // You could add more specific messages here if needed, e.g., based on search term
                productGridContainer.innerHTML = `<p class="text-center text-gray-300 col-span-full py-10">${message}</p>`;
                return;
            }

            productsToRender.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'content-card product-card';
                const productImage = product.image || `https://placehold.co/400x400/334155/e2e8f0?text=${encodeURIComponent(product.name)}`;
                productCard.innerHTML = `
                    <div class="flex-grow">
                        <div class="product-image-container rounded-md overflow-hidden mb-4">
                            <img src="${productImage}" alt="${product.name}" class="w-full h-full object-cover" onerror="this.src='https.placehold.co/400x400/334155/e2e8f0?text=Image+Not+Found'; this.alt='Image not available';">
                        </div>
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-50 mb-1">${product.name}</h3>
                        <p class="text-sm ${product.textColorClass || 'text-gray-300'} mb-1">${product.description}</p>
                        <p class="text-xs text-gray-400 mb-3">${product.details}</p>
                    </div>
                    <div class="mt-4">
                        <p class="text-xl sm:text-2xl font-bold rainbow-text mb-3">R${product.price.toFixed(2)}</p>
                        <button class="add-to-cart-btn rainbow-button ${product.colorClass || 'btn-indigo'} w-full text-sm" data-product-name="${product.name}" data-price="${product.price.toFixed(2)}">Add to Cart</button>
                    </div>
                `;
                productGridContainer.appendChild(productCard);
            });
            addEventListenersToCartButtons();
        }

        function performSearchAndSort() {
            const searchTerm = searchBar.value.toLowerCase().trim();
            const sortBy = sortSelect.value;

            if (searchTerm) {
                searchTermDisplay.textContent = `Searching for: "${searchBar.value.trim()}"`;
                searchTermDisplay.classList.remove('hidden');
            } else {
                searchTermDisplay.classList.add('hidden');
            }

            let _products; // Corrected typo here
            if (searchTerm === '') {
                _products = [...initialProducts];
            } else {
                _products = initialProducts.filter(product =>
                    (product.name && product.name.toLowerCase().includes(searchTerm)) ||
                    (product.description && product.description.toLowerCase().includes(searchTerm)) ||
                    (product.details && product.details.toLowerCase().includes(searchTerm))
                );
            }

            if (sortBy === 'price_asc') {
                _products.sort((a, b) => a.price - b.price);
            } else if (sortBy === 'price_desc') {
                _products.sort((a, b) => b.price - a.price);
            } else if (sortBy === 'newest') {
                _products.sort((a, b) => b.id - a.id); 
            } else if (sortBy === 'featured') {
                _products.sort((a, b) => a.originalFeaturedOrder - b.originalFeaturedOrder);
            }
            renderProducts(_products);
        }


        function updateCartDisplay() {
            cartItemCountElement.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartModalBody.innerHTML = '';
            let subtotal = 0;

            if (cart.length === 0) {
                cartModalBody.appendChild(emptyCartMessage);
                emptyCartMessage.style.display = 'block';
                proceedToCheckoutDetailsBtn.classList.add('opacity-50', 'cursor-not-allowed');
                deliveryFeeSectionCart.style.display = 'none';
            } else {
                emptyCartMessage.style.display = 'none';
                proceedToCheckoutDetailsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                cart.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('cart-modal-item', 'py-2.5', 'flex', 'justify-between', 'items-center', 'gap-3');
                    itemElement.innerHTML = `
                        <div class="flex-grow min-w-0">
                            <p class="text-white text-sm font-medium truncate" title="${item.name}">${item.name}</p>
                            <p class="text-purple-300 text-xs">R${item.price.toFixed(2)} x ${item.quantity}</p>
                        </div>
                        <p class="text-gray-200 text-sm font-semibold whitespace-nowrap">R${(item.price * item.quantity).toFixed(2)}</p>
                        <button class="remove-from-cart-btn text-red-400 hover:text-red-500 text-lg p-1 rounded-md transition-colors" data-index="${index}" title="Remove item">&times;</button>
                    `;
                    cartModalBody.appendChild(itemElement);
                    subtotal += item.price * item.quantity;
                });
            }
            
            cartSubtotalElement.textContent = `R${subtotal.toFixed(2)}`;

            let deliveryFee = 0;
            if (subtotal > 0 && subtotal < 500) {
                deliveryFee = 50;
                cartDeliveryFeeElement.textContent = `R${deliveryFee.toFixed(2)}`;
                deliveryFeeSectionCart.style.display = 'flex';
            } else {
                deliveryFeeSectionCart.style.display = 'none';
            }

            const grandTotal = subtotal + deliveryFee;
            cartGrandTotalElement.textContent = `R${grandTotal.toFixed(2)}`;
            
            sessionStorage.setItem('nicfixCart', JSON.stringify(cart));
        }
        
        updateCartDisplay();
        
        function createSmokeEffect(button, event) {
            const clickX = event.clientX;
            const clickY = event.clientY;
        
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.classList.add('smoke-particle');
                document.body.appendChild(particle);
            
                const size = Math.random() * 25 + 10;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                particle.style.left = `${clickX - size / 2}px`;
                particle.style.top = `${clickY - size / 2}px`;
                
                const angle = (Math.random() - 0.5) * Math.PI;
                const distance = Math.random() * 80 + 40;
                particle.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
                particle.style.setProperty('--ty', `${Math.sin(angle) * distance - 90}px`);
            
                particle.addEventListener('animationend', () => {
                    particle.remove();
                });
            }
        
            if(cartLink){
                const svgIcon = cartLink.querySelector('svg');
                if (svgIcon) {
                    svgIcon.parentElement.classList.add('cart-icon-spin');
                }
                cartItemCountElement.classList.add('cart-count-pulse');
                setTimeout(() => {
                    if (svgIcon) svgIcon.parentElement.classList.remove('cart-icon-spin');
                    cartItemCountElement.classList.remove('cart-count-pulse');
                }, 600);
            }
        }

        function addEventListenersToCartButtons() {
            const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
            addToCartButtons.forEach(button => {
                button.replaceWith(button.cloneNode(true)); 
            });
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const productName = button.getAttribute('data-product-name');
                    const productPrice = parseFloat(button.getAttribute('data-price'));
                    const existingItem = cart.find(item => item.name === productName);

                    if (existingItem) {
                        existingItem.quantity += 1;
                    } else {
                        cart.push({ name: productName, price: productPrice, quantity: 1 });
                    }
                    updateCartDisplay();
                    createSmokeEffect(button, event);

                    const originalText = button.textContent;
                    const originalClasses = Array.from(button.classList);
                    const colorClassToRemove = originalClasses.find(cls => cls.startsWith('btn-') && cls !== 'btn-green');


                    button.textContent = 'Added!';
                    if (colorClassToRemove) button.classList.remove(colorClassToRemove);
                    button.classList.add('btn-green');


                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('btn-green');
                        if(colorClassToRemove) button.classList.add(colorClassToRemove);
                    }, 1500);
                });
            });
        }
        
        performSearchAndSort();
        searchBar.addEventListener('input', performSearchAndSort);
        sortSelect.addEventListener('change', performSearchAndSort);


        cartModalBody.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-from-cart-btn') || event.target.closest('.remove-from-cart-btn')) {
                const button = event.target.closest('.remove-from-cart-btn');
                const itemIndex = parseInt(button.getAttribute('data-index'));
                cart.splice(itemIndex, 1);
                updateCartDisplay();
            }
        });
        
        function openModal(modalElement, modalContentElement) {
            modalElement.classList.remove('hidden');
            setTimeout(() => {
                modalElement.classList.remove('opacity-0');
                modalContentElement.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeModal(modalElement, modalContentElement) {
            modalElement.classList.add('opacity-0');
            modalContentElement.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modalElement.classList.add('hidden');
            }, 300);
        }

        if (cartLink) {
            cartLink.addEventListener('click', (e) => {
                e.preventDefault();
                updateCartDisplay();
                openModal(cartModal, cartModalContent);
            });
        }
        if (closeCartModalBtn) {
            closeCartModalBtn.addEventListener('click', () => closeModal(cartModal, cartModalContent));
        }
        cartModal.addEventListener('click', (event) => {
            if (event.target === cartModal) {
                closeModal(cartModal, cartModalContent);
            }
        });

        if (proceedToCheckoutDetailsBtn) {
            proceedToCheckoutDetailsBtn.addEventListener('click', () => {
                if (cart.length === 0) return;
                closeModal(cartModal, cartModalContent);
                openModal(checkoutDetailsModal, checkoutDetailsModalContent);
            });
        }

        if (closeCheckoutDetailsModalBtn) {
            closeCheckoutDetailsModalBtn.addEventListener('click', () => closeModal(checkoutDetailsModal, checkoutDetailsModalContent));
        }
        checkoutDetailsModal.addEventListener('click', (event) => {
            if (event.target === checkoutDetailsModal) {
                closeModal(checkoutDetailsModal, checkoutDetailsModalContent);
            }
        });
        if (backToCartBtn) {
            backToCartBtn.addEventListener('click', () => {
                closeModal(checkoutDetailsModal, checkoutDetailsModalContent);
                openModal(cartModal, cartModalContent);
            });
        }

        if (confirmOrderBtn) {
            confirmOrderBtn.addEventListener('click', () => {
                let isValid = true;
                checkoutFormError.classList.add('hidden');
                paymentMethodError.classList.add('hidden');
                ageConfirmationError.classList.add('hidden');
                document.querySelectorAll('#checkoutDetailsModal .checkout-details-error:not(#paymentMethodError):not(#checkoutFormError):not(#ageConfirmationError)').forEach(el => el.classList.add('hidden'));


                if (!firstNameInput.value.trim()) {
                    document.getElementById('firstNameError').classList.remove('hidden');
                    isValid = false;
                }
                if (!surnameInput.value.trim()) {
                    document.getElementById('surnameError').classList.remove('hidden');
                    isValid = false;
                }
                if (!addressInput.value.trim()) {
                    document.getElementById('addressError').classList.remove('hidden');
                    isValid = false;
                }
                if (!phoneInput.value.trim()) {
                    document.getElementById('phoneError').classList.remove('hidden');
                    isValid = false;
                }
                
                const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
                if (!selectedPaymentMethod) {
                    paymentMethodError.classList.remove('hidden');
                    isValid = false;
                }
                if (!ageConfirmationCheckbox.checked) {
                    ageConfirmationError.classList.remove('hidden');
                    isValid = false;
                }


                if (!isValid) {
                    checkoutFormError.classList.remove('hidden');
                    return;
                }
                
                let subtotalAmount = 0;
                cart.forEach(item => {
                    subtotalAmount += item.price * item.quantity;
                });

                let deliveryFee = 0;
                if (subtotalAmount > 0 && subtotalAmount < 500) {
                    deliveryFee = 50;
                }
                const grandTotalAmount = subtotalAmount + deliveryFee;


                let emailBody = "Hello NicFix Team,\n\nI would like to place an order for the following items:\n\n";
                emailBody += "CUSTOMER DETAILS:\n";
                emailBody += `Name: ${firstNameInput.value.trim()} ${surnameInput.value.trim()}\n`;
                emailBody += `Address: ${addressInput.value.trim()}\n`;
                emailBody += `Phone: ${phoneInput.value.trim()}\n`;
                emailBody += `Payment Method: ${selectedPaymentMethod.value}\n`;
                emailBody += `Age Confirmed (18+): Yes\n\n`;
                emailBody += "ORDER ITEMS:\n";

                cart.forEach(item => {
                    emailBody += `- ${item.name} (Quantity: ${item.quantity}) - Price: R${item.price.toFixed(2)} each - Subtotal: R${(item.price * item.quantity).toFixed(2)}\n`;
                });
                
                emailBody += `\n----------------------------------`;
                emailBody += `\nSUBTOTAL: R${subtotalAmount.toFixed(2)}`;
                if (deliveryFee > 0) {
                    emailBody += `\nDELIVERY FEE: R${deliveryFee.toFixed(2)}`;
                }
                emailBody += `\nGRAND TOTAL: R${grandTotalAmount.toFixed(2)}`;
                emailBody += "\n----------------------------------";
                emailBody += "\n\nPlease advise on payment methods and delivery options to Springs, Gauteng.";
                emailBody += "\n\nLooking forward to my NicFix!";
                emailBody += `\n\nKind regards,\n${firstNameInput.value.trim()} ${surnameInput.value.trim()}`;


                const mailtoLink = `mailto:nicfix.shop@gmail.com?cc=nalydnetsrak@gmail.com&subject=${encodeURIComponent('New Vape Order from NicFix Website')}&body=${encodeURIComponent(emailBody)}`;
                
                window.location.href = mailtoLink;

                cart = [];
                updateCartDisplay();
                sessionStorage.removeItem('nicfixCart');
                
                firstNameInput.value = '';
                surnameInput.value = '';
                addressInput.value = '';
                phoneInput.value = '';
                if(selectedPaymentMethod) selectedPaymentMethod.checked = false;
                ageConfirmationCheckbox.checked = false;
                
                setTimeout(() => {
                    closeModal(checkoutDetailsModal, checkoutDetailsModalContent);
                }, 500);
            });
        }
        
        document.getElementById('currentYear').textContent = new Date().getFullYear();
    });
    </script>

</body>
</html>
